#define modCord_cxx
#include "modCord.h"
#include <TH2.h>
#include <TStyle.h>
#include <TCanvas.h>
#include <algorithm>
#include <TLine.h>
#include <iostream>
#include <TFile.h>
#include <TColor.h>
#include <TF1.h>
#include <TGraph.h>
#include <TMath.h>
#include "parametric_plot.h"
#include "canvas_pavetext.h"

using namespace std;


void modCord::Loop()
{
	vector< vector<int> > module_list_tower;
	module_list_tower.clear();
//	cout << "koko" <<endl;

	vector<int> mod33 = {50118,50119,50120,50121,50122,50123,50124,50216,50217,50218,50219,50220,50221,50222,50223,50224,50225,50317,50318,50319,50320,50321,50322,50323,50324,50325,50417,50418,50419,50420,50421,50422,50423,50424,50425,60223,60224,60225,60226,60227,60228,60229,60230,60323,60324,60325,60326,60327,60328,60329,60330,60331,60422,60423,60424,60425,60426,60427,60428,60429,60430,60431,60523,60524,60525,60526,60527,60528,60529,60530,60531,60622,60623,60624,60625,60626,60627,60628,60629,60630,60631,70429,70430,70431,70432,70433,70434,70435,70436,70437,70438,70529,70530,70531,70532,70533,70534,70535,70536,70537,70538,70629,70630,70631,70632,70633,70634,70635,70636,70637,70638,70729,70730,70731,70732,70733,70734,70735,70736,70737,70738,70829,70830,70831,70832,70833,70834,70835,70836,70837,70838,70929,70930,70931,70932,70933,70934,70935,70936,70937,70938,80617,80618,80619,80620,80621,80622,80623,80717,80718,80719,80720,80721,80722,80723,80817,80818,80819,80820,80821,80822,80823,80917,80918,80919,80920,80921,80922,80923,81017,81018,81019,81020,81021,81022,81023,81117,81118,81119,81120,81121,81122,81123,81217,81218,81219,81220,81221,81222,81223,90719,90720,90721,90722,90723,90818,90819,90820,90821,90822,90823,90918,90919,90920,90921,90922,90923,91018,91019,91020,91021,91022,91023,91118,91119,91120,91121,91122,91123,91218,91219,91220,91221,91222,91223,91318,91319,91320,91321,91322,91323,91418,91419,91420,91421,91422,91423,91518,91519,91520,91521,91522,91523,100920,100921,100922,100923,101019,101020,101021,101022,101023,101120,101121,101122,101123,101219,101220,101221,101222,101223,101319,101320,101321,101322,101323,101419,101420,101421,101422,101423,101520,101521,101522,101523,101619,101620,101621,101622,101623,101720,101721,101722,101723,101819,101820,101821,101822,101823,101920,101921,101922,101923,110905,110906,110907,110908,110909,110910,110911,111006,111007,111008,111009,111010,111011,111012,111013,111107,111108,111109,111110,111111,111112,111113,111114,111115,111208,111209,111210,111211,111212,111213,111214,111215,111216,111309,111310,111311,111312,111313,111314,111315,111316,111317,111318,111409,111410,111411,111412,111413,111414,111415,111416,111417,111418,111419,121107,121108,121109,121110,121111,121112,121113,121114,121115,121208,121209,121210,121211,121212,121213,121214,121215,121216,121309,121310,121311,121312,121313,121314,121315,121316,121317,121318,121409,121410,121411,121412,121413,121414,121415,121416,121417,121418,121419,130908,130909,130910,130911,130912,130913,130914,130915,130916,131009,131010,131011,131012,131013,131014,131015,131016,131017,131018,131109,131110,131111,131112,131113,131114,131115,131116,131117,131118,131119,141109,141110,141111,141112,141113,141114,141115,141116,141117,141118,141119,
	};
	vector<int> mod41 = {50123,50124,50125,50126,50127,50128,50129,50223,50224,50225,50226,50227,50228,50229,50323,50324,50325,50326,50327,50328,50329,50423,50424,50425,50426,50427,50428,50429,60230,60231,60232,60233,60234,60330,60331,60332,60333,60334,60430,60431,60432,60433,60434,60530,60531,60532,60533,60534,60630,60631,60632,60633,60634,70438,70439,70538,70539,70638,70639,70738,70739,70838,70839,70938,70939,110002,110003,110004,110005,110102,110103,110104,110105,110106,110107,110203,110204,110205,110206,110303,110304,110305,110306,110307,110404,110405,110406,110407,110408,110504,110505,110506,110507,110508,110604,110605,110606,110607,110608,110609,110705,110706,110707,110708,110709,110710,110805,110806,110807,110808,110809,110810,110905,110906,110907,110908,110909,110910,110911,111010,120002,120003,120004,120005,120102,120103,120104,120105,120106,120203,120204,120205,120206,120303,120304,120305,120306,120307,120404,120405,120406,120407,120408,120504,120505,120506,120507,120508,120604,120605,120606,120607,120608,120609,120705,120706,120707,120708,120709,120710,120805,120806,120807,120808,120809,120810,120905,120906,120907,120908,120909,120910,120911,121006,121007,121008,121009,121010,121011,121012,121013,121107,121108,121109,121110,121111,121112,121113,121114,121115,130003,130004,130005,130006,130007,130008,130103,130104,130105,130106,130107,130204,130205,130206,130207,130208,130304,130305,130306,130307,130308,130309,130404,130405,130406,130407,130408,130409,130505,130506,130507,130508,130509,130510,130605,130606,130607,130608,130609,130610,130611,130706,130707,130708,130709,130710,130711,130712,130713,130807,130808,130809,130810,130811,130812,130813,130814,130908,130909,130910,130911,130912,130913,130914,130915,130916,131009,131010,131011,131012,131013,131014,131015,131016,131017,131018,140103,140104,140105,140106,140107,140204,140205,140206,140207,140208,140304,140305,140306,140307,140308,140309,140310,140404,140405,140406,140407,140408,140409,140505,140506,140507,140508,140509,140510,140605,140606,140607,140608,140609,140610,140611,140706,140707,140708,140709,140710,140711,140712,140713,140807,140808,140809,140810,140811,140812,140813,140814,140908,140909,140910,140911,140912,140913,140914,140915,140916,141009,141010,141011,141012,141013,141014,141015,141016,141017,141018,141109,141110,141111,141112,141113,141114,141115,141116,141117,141118,141119,150304,150305,150306,150307,150308,150309,150404,150405,150406,150407,150408,150409,150505,150506,150507,150508,150509,150510,150605,150606,150607,150608,150609,150610,150611,150706,150707,150708,150709,150710,150711,150712,150713,150807,150808,150809,150810,150811,150812,150813,150814,150908,150909,150910,150911,150912,150913,150914,150915,150916,151009,151010,151011,151012,151013,151014,151015,151016,151017,151018,151109,151110,151111,151112,151113,151114,151115,151116,151117,151118,151119,
	};
	vector<int> mod25 = {50113,50114,50115,50116,50117,50118,50119,50120,50212,50213,50214,50215,50216,50217,50218,50219,50220,50312,50313,50314,50315,50316,50317,50318,50319,50320,50412,50413,50414,50415,50416,50417,50418,50419,50420,60216,60217,60218,60219,60220,60221,60222,60223,60224,60316,60317,60318,60319,60320,60321,60322,60323,60324,60416,60417,60418,60419,60420,60421,60422,60423,60424,60516,60517,60518,60519,60520,60521,60522,60523,60524,60616,60617,60618,60619,60620,60621,60622,60623,60624,70420,70421,70422,70423,70424,70425,70426,70427,70428,70429,70519,70520,70521,70522,70523,70524,70525,70526,70527,70528,70529,70620,70621,70622,70623,70624,70625,70626,70627,70628,70629,70720,70721,70722,70723,70724,70725,70726,70727,70728,70729,70820,70821,70822,70823,70824,70825,70826,70827,70828,70829,70920,70921,70922,70923,70924,70925,70926,70927,70928,70929,80611,80612,80613,80614,80615,80616,80617,80711,80712,80713,80714,80715,80716,80717,80811,80812,80813,80814,80815,80816,80817,80911,80912,80913,80914,80915,80916,80917,81011,81012,81013,81014,81015,81016,81017,81111,81112,81113,81114,81115,81116,81117,81211,81212,81213,81214,81215,81216,81217,90712,90713,90714,90715,90716,90717,90719,90811,90812,90813,90814,90815,90816,90817,90818,90819,90911,90912,90913,90914,90915,90916,90917,90918,90919,91011,91012,91013,91014,91015,91016,91017,91018,91019,91111,91112,91113,91114,91115,91116,91117,91118,91119,91211,91212,91213,91214,91215,91216,91217,91218,91219,91311,91312,91313,91314,91315,91316,91317,91318,91319,91411,91412,91413,91414,91415,91416,91417,91418,91419,91511,91512,91513,91514,91515,91516,91517,91518,91519,100911,100912,100913,100914,100915,100916,100917,100918,100919,100920,100921,100922,101011,101012,101013,101014,101015,101016,101017,101018,101019,101020,101021,101110,101111,101112,101113,101114,101115,101116,101117,101118,101119,101120,101121,101122,101210,101211,101212,101213,101214,101215,101216,101217,101218,101219,101220,101221,101310,101311,101312,101313,101314,101315,101316,101317,101318,101319,101320,101321,101411,101412,101413,101414,101415,101416,101417,101418,101419,101420,101421,101511,101512,101513,101514,101515,101516,101517,101518,101519,101520,101521,101522,101611,101612,101613,101614,101615,101616,101617,101618,101619,101620,101621,101710,101711,101712,101713,101714,101715,101716,101717,101718,101719,101720,101721,101722,101810,101811,101812,101813,101814,101815,101816,101817,101818,101819,101820,101821,101911,101912,101913,101914,101915,101916,101917,101918,101919,101920,101921,101922,
	};
	module_list_tower.push_back(mod25);
	module_list_tower.push_back(mod33);
	module_list_tower.push_back(mod41);

	vector< vector< TLine> >  tower_line ;
	vector< vector< TLine> >  tower_line_rz ;
	tower_line.clear();
	tower_line.resize(3);
	tower_line.at(0).clear();
	tower_line.at(1).clear();
	tower_line.at(2).clear();

	tower_line_rz.clear();
	tower_line_rz.resize(3);
	tower_line_rz.at(0).clear();
	tower_line_rz.at(1).clear();
	tower_line_rz.at(2).clear();

	int mod_count[3][3]={0};//3 tower, ps,2s, total

	int tower[3]={25,33,41};

	TH2F * xy[11];
	TH2F * xy_all[3];
	TH2F * rz_all[3];
	int lay;
	char name[100];
	for(int l =0; l<11; ++l){
		sprintf(name,"modplot_xy_lay_%2i",l);
		xy[l] = new TH2F(TString(name),"xy_",1000,-30,130,1000,-10,130);
		xy[l]->SetTitle(TString(name)+";x [cm];y [cm]");
	}
	for(int l =0; l<3; ++l){
		sprintf(name,"xy_all_TT%2i",tower[l]);
		xy_all[l] = new TH2F(TString(name),"xy_all",1000,-30,130,1000,-10,130);
		xy_all[l]->SetTitle(TString(name)+";x [cm];y [cm]");

		sprintf(name,"rz_all_TT%2i",tower[l]);
		rz_all[l] = new TH2F(TString(name),"zr_all",1000,0,300,1000,0,130);
		rz_all[l]->SetTitle(TString(name)+";z [cm];r [cm]");

	}

	if (fChain == 0) return;
	Long64_t nentries = fChain->GetEntriesFast();
	Long64_t nbytes = 0, nb = 0;
	for (Long64_t jentry=0; jentry<nentries;jentry++) {
		Long64_t ientry = LoadTree(jentry);
		if (ientry < 0) break;
		nb = fChain->GetEntry(jentry);   nbytes += nb;

		vector<int>::iterator is_module;
		lay = floor(module_id/10000);

		int color;

		for (int i = 0; i<3; ++i){
			is_module = find(module_list_tower.at(i).begin(),module_list_tower.at(i).end(),module_id);
			if (is_module != module_list_tower.at(i).end() ) {


				for (int j=0; j<4; j++){
					xy[lay-5] -> Fill(x_coords->at(j),y_coords->at(j));
					xy_all[i] -> Fill(x_coords->at(j),y_coords->at(j));
					rz_all[i] -> Fill(z_coords->at(j),r_coords->at(j));
				}

				TLine * a = new TLine(x_coords->at(0),y_coords->at(0), x_coords->at(1),y_coords->at(1));
				TLine * b = new TLine(x_coords->at(1),y_coords->at(1), x_coords->at(2),y_coords->at(2));
				TLine * c = new TLine(x_coords->at(2),y_coords->at(2), x_coords->at(3),y_coords->at(3));
				TLine * d = new TLine(x_coords->at(3),y_coords->at(3), x_coords->at(0),y_coords->at(0));

				TLine * eta = new TLine(z_coords->at(0),r_coords->at(0), z_coords->at(2),r_coords->at(2));

				if (is_ps) {
					mod_count[i][0]++;
					color = 2;
				}
				else {
					mod_count[i][1]++;
					color = 4;
				}


				a->SetLineColor(color);
				b->SetLineColor(color);
				c->SetLineColor(color);
				d->SetLineColor(color);

				eta->SetLineColor(color);

				tower_line.at(i).push_back(*a);
				tower_line.at(i).push_back(*b);
				tower_line.at(i).push_back(*c);
				tower_line.at(i).push_back(*d);
				tower_line_rz.at(i).push_back(*eta);

			}
			else continue;
		}
	}

	TCanvas * c[3];
	TCanvas * d[3];

	text pt;
	pt.add_pave(0.7,0.2,0.90,0.5,"NDC");
	pt.add_pave(0.7,0.2,0.90,0.5,"NDC");
	pt.add_pave(0.7,0.2,0.90,0.5,"NDC");

	for (int r=2; r <3; r++){
		c[r] = new TCanvas();
		c[r]->Range(-30,-10,130,130);
		xy_all[r]->Draw();



		parametric_plot f1(0.40,1);
//		parametric_plot f2(0.61,-1);
		parametric_plot f3(1.85,1);
//		parametric_plot f4(1.4,-1);

		f1.setColor(kRed);
		f1.plot("L"); //"P" draw on same canvas with range already set. "AP" draws new axis.
//		f2.plot("L");
		f3.setColor(kRed);
		f3.plot("L");
//		f4.plot("L");
//		for (unsigned int q=0; q <tower_line.at(r).size() ; ++q){
//			tower_line.at(r).at(q).Draw();
////			tower_line.at(r).at(q).Print();
//			c[r]->Update();
//			if(q%100==0) cout << "100 lines drawn" <<endl;
//		}

		sprintf(name, "# ps_modules: %3i", mod_count[r][0]);
		pt.add_text(name,kBlue,r);
		sprintf(name, "# 2s_modules: %3i", mod_count[r][1]);
		pt.add_text(name,kRed,r);
		sprintf(name, "# tot modules: %3i", mod_count[r][0]+mod_count[r][1]);
		pt.add_text(name,kBlack,r);

		pt.draw_pave(r);

//
//		d[r] = new TCanvas();
//		d[r]->Range(0,0,300,130);
//		rz_all[r]->Draw();
//
//		for (unsigned int q=0; q <tower_line_rz.at(r).size() ; ++q){
//			tower_line_rz.at(r).at(q).Draw();
//			//			tower_line.at(r).at(q).Print();
//			d[r]->Update();
//			if(q%100==0) cout << "100 lines drawn" <<endl;
//		}


		c[r]->Write();
//		d[r]->Write();
	}


}



void modCord_flower_run(){

	gStyle->SetOptStat(0);
	bool isfOpen;
	TFile* f = 0; isfOpen = false;
	f = new TFile("plottower.root","RECREATE");
	isfOpen = f->IsOpen();
	if (!isfOpen) {
		cout << "ERROR. Not able to load the output file. Exiting..." << endl;
		return;
	}
	modCord a;
	f->cd();
	cout << "gugu " <<endl;
	a.Loop();

	f->Write();
	return;

}
